<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Groq AI Soal Bergambar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/style.css">
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; }
.container { max-width: 800px; margin:20px auto; padding:20px; background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1 { text-align:center; margin-bottom:20px;}
form { display:flex; flex-direction:column; gap:10px; }
textarea { width:100%; padding:10px; border-radius:5px; border:1px solid #ccc; resize: vertical; }
#fileName { font-size:0.9rem; color:#555; margin-bottom:5px; }
.btn, .btn-green, .btn-blue { padding:10px 15px; border-radius:5px; border:none; cursor:pointer; }
.btn-green { background:#28a745; color:#fff; }
.btn-blue { background:#007bff; color:#fff; }
.actions { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.actions button { flex:1; padding:15px; border-radius:8px; background:#007bff; color:#fff; border:none; cursor:pointer; }
.soal-item { margin-bottom:20px; }
.soal-item img { max-width:200px; display:block; margin-bottom:10px; }
</style>
</head>
<body>
<div class="container">
<h1>Otomatis soal bergambar dari buku</h1>

<form id="aiForm" enctype="multipart/form-data">
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
    <label class="btn btn-green">
      üì∑ Ambil Foto
      <input type="file" id="fotoCamera" accept="image/*" capture="environment" style="display:none" multiple>
    </label>

    <label class="btn btn-blue">
      üñºÔ∏è Pilih dari Media
      <input type="file" id="fotoMedia" accept="image/*" style="display:none" multiple>
    </label>
  </div>

  <div id="fileName"></div>

  <select name="jenis" required>
    <option value="">Jenis Soal</option>
    <option value="Pilihan Ganda">Pilihan Ganda</option>
    <option value="Essay">Essay</option>
    <option value="Pilihan Ganda dan Essay">PG + Essay</option>
  </select>

  <input type="number" name="jumlah" placeholder="Jumlah Soal" required>
  <button type="submit" class="btn-green">üöÄ Proses ke AI</button>
</form>

<hr>

<h3>Soal Bergambar</h3>
<div id="soalContainer"></div>

<h3>Jawaban</h3>
<textarea id="jawaban" rows="10" readonly></textarea>

<div class="actions">
  <button type="button" onclick="printPage()">üñ®Ô∏è Print</button>
  <button type="button" id="exportWordBtn">üìÑ Export Word</button>
</div>
</div>

<script>
const fotoCamera = document.getElementById("fotoCamera");
const fotoMedia = document.getElementById("fotoMedia");
const fileName = document.getElementById("fileName");
const soalContainer = document.getElementById("soalContainer");
const jawabanArea = document.getElementById("jawaban");

let selectedFiles = [];

function updateFileName() {
  if(selectedFiles.length > 0){
    fileName.textContent = "File: " + selectedFiles.map(f=>f.name).join(", ");
  } else { fileName.textContent = ""; }
}

fotoCamera.addEventListener("change", () => {
  if(fotoCamera.files.length > 0){
    selectedFiles = Array.from(fotoCamera.files);
    updateFileName();
  }
});

fotoMedia.addEventListener("change", () => {
  if(fotoMedia.files.length > 0){
    selectedFiles = Array.from(fotoMedia.files);
    updateFileName();
  }
});

document.getElementById("aiForm").addEventListener("submit", async e => {
  e.preventDefault();
  if(selectedFiles.length === 0){ alert("Pilih minimal 1 foto"); return; }

  const formData = new FormData();
  selectedFiles.forEach(f => formData.append("foto", f));
  formData.append("jenis", document.querySelector("select[name=jenis]").value);
  formData.append("jumlah", document.querySelector("input[name=jumlah]").value);

  soalContainer.innerHTML = "Sedang memproses AI... ‚è≥";
  jawabanArea.value = "";

  try {
    const res = await fetch("/ai/process", { method:"POST", body: formData });
    const data = await res.json();
    if(data.hasil){
      // Hasil AI sudah bersih tanpa ===SOAL===
      const lines = data.hasil.split("\n");
      soalContainer.innerHTML = "";
      lines.forEach((line,i) => {
        if(line.startsWith("http") && (line.endsWith(".jpg") || line.endsWith(".png"))) {
          const img = document.createElement("img");
          img.src = line; 
          soalContainer.appendChild(img);
        } else {
          const p = document.createElement("p");
          p.textContent = line;
          soalContainer.appendChild(p);
        }
      });
      jawabanArea.value = data.jawaban || "";
      window.wordFile = data.wordFile || null;
    } else { soalContainer.innerHTML=""; jawabanArea.value=""; alert("Gagal memproses AI"); }
  } catch(err){ console.error(err); alert("Terjadi kesalahan AI"); }
});

function printPage(){ window.print(); }
document.getElementById("exportWordBtn").addEventListener("click", () => {
  if(window.wordFile){ window.location.href = window.wordFile; }
  else { alert("Belum ada file Word, proses AI dulu"); }
});
</script>
</body>
</html>
